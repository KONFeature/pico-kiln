<!DOCTYPE html>
<html>
<head>
<title>PID Tuning</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>.hidden{display:none}</style>
</head>
<body>
<h1>PID Auto-Tuning</h1>
<p><button onclick="location.href='/'">Back</button></p>

<h2>About</h2>
<p>Calculates optimal PID parameters using Ziegler-Nichols method.</p>
<p><b>How it works:</b></p>
<ol>
<li>Kiln heats to target at full power</li>
<li>Heating turns off, kiln cools to target</li>
<li>Data saved to CSV for external analysis</li>
</ol>

<h2>Safety</h2>
<ul>
<li>Ensure kiln is cool (room temp)</li>
<li>No profile should be running</li>
<li>Takes 10-30 minutes</li>
<li>Do not interrupt</li>
</ul>

<h2>Controls</h2>
<label>Target Temp (C): <input type="number" id="targetTemp" value="200" min="50" max="500"></label>
<p><small>Recommended: 200C for initial tuning</small></p>
<div id="controlButtons">
<button id="startBtn" onclick="startTuning()">Start Tuning</button>
<button class="hidden" id="stopBtn" onclick="stopTuning()">Stop Tuning</button>
</div>

<h2>Status</h2>
<p><b>Stage:</b> <span id="stageIndicator">IDLE</span></p>
<p>Current Temp: <span id="currentTemp">--</span></p>
<p>Target Temp: <span id="targetTempDisplay">--</span></p>
<p>Elapsed: <span id="elapsedTime">--</span></p>
<p>Data Points: <span id="dataPoints">--</span></p>
<div id="errorDisplay" class="hidden">
<p><b>Error:</b> <span id="errorMessage"></span></p>
</div>
<div id="completeDisplay" class="hidden">
<p><b>Tuning Complete!</b></p>
<p>Data saved to: <b>tuning_data.csv</b></p>
<p>Process the data externally to calculate PID values.</p>
</div>

<script>
let pollingInterval = null;

function startTuning() {
const targetTemp = parseFloat(document.getElementById('targetTemp').value);
if (isNaN(targetTemp) || targetTemp < 50 || targetTemp > 500) {
alert('Enter valid temp (50-500C)');
return;
}
if (!confirm(`Start tuning at ${targetTemp}C?\n\nTakes 10-30 min. Kiln must be cool.`)) return;

document.getElementById('startBtn').disabled = true;
document.getElementById('stopBtn').classList.remove('hidden');
document.getElementById('targetTemp').disabled = true;
document.getElementById('completeDisplay').classList.add('hidden');
document.getElementById('errorDisplay').classList.add('hidden');

fetch('/api/tuning/start', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({target_temp: targetTemp})
})
.then(r => r.json())
.then(d => {
if (d.success) {
startPolling();
} else {
alert('Error: ' + d.error);
resetControls();
}
})
.catch(e => {
alert('Failed: ' + e);
resetControls();
});
}

function stopTuning() {
if (!confirm('Stop tuning? Data will be lost.')) return;
fetch('/api/tuning/stop', {method: 'POST'})
.then(r => r.json())
.then(d => {
stopPolling();
resetControls();
})
.catch(e => alert('Failed: ' + e));
}

function startPolling() {
pollingInterval = setInterval(updateStatus, 2000);
updateStatus();
}

function stopPolling() {
if (pollingInterval) {
clearInterval(pollingInterval);
pollingInterval = null;
}
}

function updateStatus() {
fetch('/api/tuning/status')
.then(r => r.json())
.then(d => {
if (d.state !== 'TUNING') {
stopPolling();
resetControls();
return;
}

const t = d.tuning;
document.getElementById('stageIndicator').textContent = t.stage.toUpperCase();
document.getElementById('currentTemp').textContent = d.current_temp.toFixed(1) + ' C';
document.getElementById('targetTempDisplay').textContent = t.target_temp + ' C';
document.getElementById('elapsedTime').textContent = formatTime(t.elapsed);
document.getElementById('dataPoints').textContent = t.data_points;

if (t.stage === 'complete') {
stopPolling();
document.getElementById('completeDisplay').classList.remove('hidden');
resetControls();
} else if (t.stage === 'error') {
stopPolling();
document.getElementById('errorMessage').textContent = t.error;
document.getElementById('errorDisplay').classList.remove('hidden');
resetControls();
}
})
.catch(e => console.error('Status error:', e));
}

function resetControls() {
document.getElementById('startBtn').disabled = false;
document.getElementById('stopBtn').classList.add('hidden');
document.getElementById('targetTemp').disabled = false;
}

function formatTime(seconds) {
const m = Math.floor(seconds / 60);
const s = Math.floor(seconds % 60);
return m + ':' + (s < 10 ? '0' : '') + s;
}

updateStatus();
</script>
</body>
</html>
