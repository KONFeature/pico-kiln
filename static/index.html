<!DOCTYPE html>
<html>
<head>
<title>Pico Kiln</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<h1>Pico Kiln</h1>

<div id="recovery-warning" style="display:none">
<b>⚠ RECOVERY MODE ⚠</b><br>
Target: <span id="recovery-target">--</span>°C
</div>

<div id="step-info" style="display:none">
Step <span id="step-progress">-/-</span> (<span id="step-type">-</span>)
</div>

<div>
<h2>Status</h2>
<p>SSR: <b id="status">--</b></p>
<p>Temp: <b id="current_temp">--</b>°C | Target: <b id="target_temp">--</b>°C</p>
<p>State: <b id="state">--</b></p>
<p>Profile: <b id="program">--</b></p>
</div>

<div id="rate-panel" style="display:none">
<h3>Rate Control</h3>
<p>Desired: <b id="rate-desired">--</b>°C/h</p>
<p>Current: <b id="rate-current">--</b>°C/h</p>
<p>Actual: <b id="rate-actual">--</b>°C/h</p>
<p id="adaptation-row" style="display:none">Adaptations: <b id="adaptation-count">0</b></p>
</div>

<h2>Profiles</h2>
{profiles_list}

<h2>Controls</h2>
<button onclick="refresh()">Refresh</button>
<button onclick="stopProgram()">Stop</button>
<button onclick="emergencyShutdown()">Emergency Stop</button>
<br><br>
<button onclick="location.href='/tuning'">PID Tuning</button>

<script>
let autoRefresh = true;

function refresh() {
  fetch('/api/status')
  .then(r => r.json())
  .then(d => {
    document.getElementById('status').textContent = d.ssr_output > 0 ? d.ssr_output.toFixed(0) + '%' : 'OFF';
    document.getElementById('current_temp').textContent = d.current_temp.toFixed(1);
    document.getElementById('target_temp').textContent = d.target_temp.toFixed(1);
    document.getElementById('program').textContent = d.profile_name || 'None';
    document.getElementById('state').textContent = d.state;

    // Recovery warning
    if (d.is_recovering && d.recovery_target_temp !== null) {
      document.getElementById('recovery-warning').style.display = 'block';
      document.getElementById('recovery-target').textContent = d.recovery_target_temp.toFixed(1);
    } else {
      document.getElementById('recovery-warning').style.display = 'none';
    }

    // Step info
    if (d.state === 'RUNNING' && d.step_index !== null && d.total_steps !== null) {
      document.getElementById('step-info').style.display = 'block';
      document.getElementById('step-progress').textContent = (d.step_index + 1) + '/' + d.total_steps;
      document.getElementById('step-type').textContent = d.step_name || '-';
    } else {
      document.getElementById('step-info').style.display = 'none';
    }

    // Rate panel
    if (d.state === 'RUNNING' && d.step_name === 'ramp' && d.desired_rate > 0) {
      document.getElementById('rate-panel').style.display = 'block';
      document.getElementById('rate-desired').textContent = d.desired_rate.toFixed(0);
      document.getElementById('rate-current').textContent = d.current_rate.toFixed(1);
      document.getElementById('rate-actual').textContent = d.actual_rate.toFixed(1);

      if (d.adaptation_count > 0) {
        document.getElementById('adaptation-row').style.display = 'block';
        document.getElementById('adaptation-count').textContent = d.adaptation_count;
      } else {
        document.getElementById('adaptation-row').style.display = 'none';
      }
    } else {
      document.getElementById('rate-panel').style.display = 'none';
    }
  })
  .catch(e => console.error('Refresh failed:', e));
}

function startProfile(name) {
  if (!confirm('Start: ' + name + '?')) return;
  fetch('/api/run', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({profile: name})
  })
  .then(r => r.json())
  .then(d => {
    alert(d.success ? 'Started' : 'Error: ' + d.error);
    refresh();
  })
  .catch(e => alert('Failed: ' + e));
}

function stopProgram() {
  if (!confirm('Stop program?')) return;
  fetch('/api/stop', {method: 'POST'})
  .then(r => r.json())
  .then(d => {
    alert(d.success ? 'Stopped' : 'Error: ' + d.error);
    refresh();
  })
  .catch(e => alert('Failed: ' + e));
}

function emergencyShutdown() {
  if (!confirm('EMERGENCY SHUTDOWN?')) return;
  fetch('/api/shutdown', {method: 'POST'})
  .then(r => r.json())
  .then(d => {
    alert(d.message);
    refresh();
  })
  .catch(e => alert('Failed: ' + e));
}

// Initial load
refresh();

// Auto-refresh every 5 seconds
setInterval(function() {
  if (autoRefresh) refresh();
}, 5000);
</script>
</body>
</html>
